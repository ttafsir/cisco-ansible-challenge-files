---
- name: TEST SYSTEM
  hosts: newsite
  gather_facts: false

  tasks:
    - name: validate playbook exists
      stat:
        path: "/workspace/ansible/configure-system.yml"
      register: playbook_result

    - name: assert that configure-system.yml exists
      assert:
        that: (playbook_result.stat.isreg is defined) and (playbook_result.stat.isreg)
        fail_msg: "FAILURE: Playbook configure-system.yml does not exist."

    - name: run show command on remote devices
      ios_command:
        commands: show running-config
      register: result

    - name: Pass text and template_path
      ansible.utils.cli_parse:
        text: "{{ result.stdout[0] }}"
        parser:
          name: ansible.utils.ttp
          template_path: "../templates/iosxe_domain.ttp"
      register: parser_output_result

    - name: extract parsed output
      set_fact:
        parsed_output: "{{ parser_output_result.parsed[0][0] }}"

    - name: assert that hostname matches
      assert:
        that: parsed_output.hostname == inventory_hostname
        fail_msg: "FAILURE: Hostname. Expected: {{ inventory_hostname }} Found: {{ parsed_output.hostname }}"        

    - name: assert that ip domain name matches
      assert:
        that: parsed_output.ip_domain_name == system_config.domain_name
        fail_msg: "FAILURE: IP domain name configuration on {{ inventory_hostname }}. Expected: {{ system_config.domain_name }} Found: {{ parsed_output.ip_domain_name }}" 

    - name: assert that ip domain search list matches
      assert:
        that: parsed_output.domain_list|sort == system_config.domain_search|sort
        fail_msg: "FAILURE: IP domain search list configuration on {{ inventory_hostname }}. Expected: {{ system_config.domain_search }} Found: {{ parsed_output.domain_list }}" 

    - name: assert that lookup source interface matches
      assert:
        that: parsed_output.lookup_source_interface == system_config.lookup_source
        fail_msg: "FAILURE: Lookup source configuration on {{ inventory_hostname }}. Expected: {{ system_config.lookup_source }} Found: {{ parsed_output.lookup_source_interface }}" 

    - name: assert that name servers match
      assert:
        that: parsed_output.name_servers|sort == system_config.name_servers|sort
        fail_msg: "FAILURE: Name server configuration on {{ inventory_hostname }}. Expected: {{ system_config.name_servers }} Found: {{ parsed_output.name_servers }}" 

    - name: assert that ip lookup is disabled
      assert:
        that: parsed_output.lookup_disabled is defined
        fail_msg: "FAILURE: Lookup is enabled. Expected: 'no ip domain lookup' on {{ inventory_hostname }}" 